#!/bin/bash

# File containing the scan results
SCAN_RESULTS="scan-results.json"

# Extract relevant information and generate markdown table
MARKDOWN_CONTENT=$(jq -r '
def hr(severity):
  if severity == "HIGH" or severity == "CRITICAL" then true else false end;
def to_md:
  "| " + (.VulnerabilityID // "") + " | " + (.PkgName // "") + " | " + (.InstalledVersion // "") + " | " + (.Severity // "") + " | " + (.Title // "") + " |";
[
  "# Docker Image Scan Results",
  "",
  "## High and Critical Vulnerabilities",
  "",
  "| Vulnerability ID | Package | Version | Severity | Description |",
  "|------------------|---------|---------|----------|-------------|",
  (.Results[] | .Vulnerabilities[] | select(hr(.Severity)) | to_md),
  ""
] | join("\n")
' $SCAN_RESULTS)

echo "$MARKDOWN_CONTENT"
